# Docs: https://github.com/Azure/webapps-deploy
name: Build and deploy Python app to Azure Web App - vehicle-dismantling-api

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: vehicle-dismantling-api

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # No need to pip install on the runner; App Service (Oryx) will install on start.

      - name: Upload backend as artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-python
          path: backend-python

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-python
          path: .

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_7663DF00EABC4498862FC7085FB509BF }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_A8E88DB4193742E0B1AD9D23B117B0A4 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_EA5334BB99E541E2A069978BFEB031B2 }}

      # Workaround the msal "NormalizedResponse" pickle error:
      # Use a fresh AZURE_CONFIG_DIR inside the container so it doesn't try to load a stale cache.
      - name: Set startup command and app settings
        uses: azure/CLI@v2
        with:
          azcliversion: 2.61.0
          inlineScript: |
            set -e
            export AZURE_CONFIG_DIR=$(mktemp -d)
            # optional: show context
            az account show -o table || true

            # Set the Linux startup command (gunicorn from site root)
            az webapp config set \
              -g ${{ vars.AZURE_RESOURCE_GROUP }} \
              -n ${{ env.AZURE_WEBAPP_NAME }} \
              --startup-file "gunicorn --chdir /home/site/wwwroot -w 2 -k gthread --threads 4 --timeout 180 -b 0.0.0.0:\$PORT main:app"

            # Ensure Oryx installs from requirements at startup
            az webapp config appsettings set \
              -g ${{ vars.AZURE_RESOURCE_GROUP }} \
              -n ${{ env.AZURE_WEBAPP_NAME }} \
              --settings SCM_DO_BUILD_DURING_DEPLOYMENT=1 ENABLE_ORYX_BUILD=1

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: Production
          package: backend-python
          clean: true
